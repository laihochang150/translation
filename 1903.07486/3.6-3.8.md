3.6 Shared memory

3.7 Global memory

3.8 TLBs



### 3.6 共享内存

T4 GPU最多可配置64 KiB的共享内存，它具有低延迟和高内存带宽。在本节中，我们将对共享内存的性能进行表征，包括在竞争条件下的性能。

#### 3.6.1 延迟

Turing的共享内存在我们考察的GPU中具有相对较低的延迟（见图3.11）。只有V100 GPU的共享内存延迟低于T4 GPU。

在所有GPU中，除了Kepler之外，随着warp中冲突数量的增加，测量到的平均访问延迟单调增加。Kepler是唯一采用双端口共享内存银行的GPU，允许任意两个线程在任意给定银行上别名，而不会受到惩罚，并且可以同时解决两个进一步的银行冲突。

#### 3.6.2 带宽

由于它们拥有大量的流式多处理器，V100和P100 GPU提供了最高的理论和测量共享内存带宽（见图3.12）。

在基准测试方面，对于Kepler、Maxwell、Pascal和Volta，我们可以依赖`nvprof`来收集共享内存指标。对于Turing，由于`nvprof`不支持该GPU上的共享内存指标收集，我们采用了以下量身定制的基准测试：

```c
__global__ void shared_memory_bandwidth_test(uint32_t *dData, uint32_t *dSink, uint32_t repeat) {
    // 每个线程的共享内存指针
    uint32_t tid = threadIdx.x;
    // 共享内存中的指针追逐数组
    __shared__ uint32_t shrData[THREAD_NUM + PCHASE_SIZE];
    // 初始化共享内存中的指针追逐数组
    for (uint32_t i = tid; i < PCHASE_SIZE; i += THREAD_NUM) {
        shrData[i] = dData[i];
    }
    // 同步同一块中的线程
    __syncthreads();
    // 使用指针追逐方法扫描共享内存数组
    uint32_t next = tid;
    for (uint32_t j = 0; j < repeat; j++) {
        next = shrData[next];
    }
    // 防止编译器优化掉代码的副作用
    dSink[tid] = next;
}
```

该基准测试对共享内存执行指针追逐访问，步数可变。我们启动尽可能多的线程和块，以对加载/存储单元施加足够的压力。我们随着指针追逐步数的增加测量执行时间。

我们通过在除Turing之外的所有架构上运行该基准测试（这些架构支持共享内存指标收集），并确认其测量的带宽与`nvprof`指标计算出的带宽相匹配，从而验证了该基准测试的正确性和准确性。


### 3.7 全局内存

我们测量了所有考虑的 GPU 上的实际全局内存带宽，并将其与理论极限进行了比较（见图 3.13）。

得益于其采用的 HBM2 内存，V100 和 P100 板卡的带宽显著高于基于 GDDR 内存的 GPU。P100 的实际带宽低于理论带宽，差距较大。与 P4 GPU 相比，T4 GPU 由于采用了 GDDR6 内存，因此享有更高的全局带宽。然而，T4 板卡的实际与理论带宽比低于 P4 板卡（68.8% 对比 84.4%）。

### 图 3.13: 所有 GPU 的理论与实际全局内存带宽。理论上限来源于 NVIDIA 的白皮书。实际带宽是我们通过基准测试得出的结果，该测试从一个全局内存数组加载数据并将其存储到另一个全局内存数组中。


### 3.8 页表项（TLBs）

在Turing以及我们考察的所有其他架构中，我们发现：

- **L1数据缓存**由虚拟地址索引；
- **L2数据缓存**由物理地址索引。

由于L2是一个物理缓存，因此访问它涉及TLBs（Translation Lookaside Buffers，地址转换后备缓冲区）。我们通过扫描一个大数组来证明这一观点，该数组的大小超过了L1 TLB的覆盖范围，因此基准测试中的访问将至少导致一次TLB未命中，前提是L1数据缓存由物理地址索引。正如预期的那样，我们在第二次扫描中没有看到TLB未命中，只要步长足够大，可以将所有访问缓存在L1数据缓存中。同一基准测试表明，当禁用L1数据缓存时，访问L2数据缓存会经过TLBs。

图3.14展示了在全局内存大小范围内，Turing GPU上存在两个TLB级别。L1 TLB具有2 MiB的页面条目和32 MiB的覆盖范围。L2 TLB的覆盖范围约为8192 MiB，这与Volta相同。

### 图3.14: 指针追逐基准测试观察到的全局内存访问延迟，随着TLB缓存的填充而变化。基准测试在TLB预热扫描后执行传统的指针追逐，计算平均全局内存访问延迟，步长等于TLB页面条目大小。
